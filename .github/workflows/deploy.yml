name: Deploy to Production

on:
  push:
    branches:
      - master
  workflow_dispatch:

env:
  NODE_VERSION: '20'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ”„ Check changes
        id: changes
        uses: dorny/paths-filter@v3
        with:
          filters: |
            nextjs:
              - 'src/**'

      - name: ðŸ”¨ Build project (verify)
        if: steps.changes.outputs.nextjs == 'true'
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -p ${{ secrets.SSH_PORT || 22 }} -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts 2>/dev/null
          
          ssh -i ~/.ssh/deploy_key \
              -o StrictHostKeyChecking=no \
              -o UserKnownHostsFile=~/.ssh/known_hosts \
              -p ${{ secrets.SSH_PORT || 22 }} \
              ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} \
              "cd ${{ secrets.PROJECT_DIR }} && \
               docker compose -f docker-compose.ci.yml build tgsip && \
               docker image prune -f && \
               docker compose up -d --no-deps tgsip && \
               echo 'âœ… Project build and deployment completed successfully!'"
          
          rm -f ~/.ssh/deploy_key